@startuml Docker Business Services
!theme plain
skinparam componentStyle rectangle
skinparam packageStyle rectangle

title Docker Business Services - High-Level Operations

' ====================================================================
' CONTRACTS
' ====================================================================
package "Contracts Layer" <<contracts>> #Honeydew {
    interface IContainerService {
        + ExecAsync()
        + StreamExecAsync()
        + CopyFileToContainerAsync()
        + StreamLogsAsync()
    }

    interface IContainerFileTransferService {
        + CopyToContainerAsync()
        + DeleteInContainerAsync()
        + RenameInContainerAsync()
        + EmptyDirectoryInContainerAsync()
    }

    interface IFileSyncService {
        + StartWatching()
        + StopWatching()
        + ForceSyncAsync()
        + CleanDirectoryAsync()
        + UpdateIgnorePatterns()
    }

    interface ICommandRunner {
        + RunAsync()
        + TryWriteToInteractiveAsync()
        + TryWriteLineToInteractiveAsync()
        + InterruptAsync()
    }

    interface ILogRunner {
        + RunAsync()
    }

    interface IIgnorePatternMatcher {
        + IsIgnored()
        + SetPatterns()
    }
}

' ====================================================================
' BUSINESS SERVICES
' ====================================================================

class ContainerFileTransferService <<sealed>> {
    - _containerService: IContainerService
    --
    + CopyToContainerAsync(id, src, dst): Task<(bool, string?)>
    + DeleteInContainerAsync(id, path): Task<(bool, string?)>
    + RenameInContainerAsync(id, old, new): Task<(bool, string?)>
    + EmptyDirectoryInContainerAsync(id, dir): Task<(bool, string?)>
    --
    <i>Wraps container operations with</i>
    <i>error handling and success/error tuples</i>
}

class FileSyncService <<sealed>> {
    - _fileTransferService: IContainerFileTransferService
    - _patternMatcher: IIgnorePatternMatcher
    - _watcher: FileSystemWatcher
    --
    + Logs: ObservableCollection<string>
    + IsWatching: bool
    + ContainerId: string?
    --
    + StartWatching(containerId, localPath, remotePath): void
    + StopWatching(): void
    + ForceSyncAsync(): Task
    + CleanDirectoryAsync(): Task
    + UpdateIgnorePatterns(patterns): void
    --
    <i>Event Handlers:</i>
    - OnFileChanged(sender, args): void
    - OnFileCreated(sender, args): void
    - OnFileDeleted(sender, args): void
    - OnFileRenamed(sender, args): void
}

class CommandRunner <<sealed>> {
    - _containerService: IContainerService
    - _inputChannel: Channel<string>
    --
    + RunAsync(id, cmd, workdir?, cancellation?): Task<int>
    + TryWriteToInteractiveAsync(input): ValueTask<bool>
    + TryWriteLineToInteractiveAsync(input): ValueTask<bool>
    + InterruptAsync(): Task
    --
    <i>Manages interactive command execution</i>
    <i>with stdin/stdout streaming via Channels</i>
}

class LogRunner <<sealed>> {
    - _containerService: IContainerService
    --
    + RunAsync(id, follow?, timestamps?, cancellation?): Task<ChannelReader<(bool, string)>>
    --
    <i>Streams container logs with</i>
    <i>stderr/stdout separation</i>
}

class IgnorePatternMatcher <<sealed>> {
    - _regexPatterns: List<Regex>
    --
    + IsIgnored(path): bool
    + SetPatterns(patterns): void
    --
    <i>Converts glob patterns to regex</i>
    <i>for .syncignore functionality</i>
}

' ====================================================================
' RELATIONSHIPS
' ====================================================================

' Implementations
ContainerFileTransferService ..|> IContainerFileTransferService
FileSyncService ..|> IFileSyncService
CommandRunner ..|> ICommandRunner
LogRunner ..|> ILogRunner
IgnorePatternMatcher ..|> IIgnorePatternMatcher

' Dependencies
ContainerFileTransferService --> IContainerService : wraps
FileSyncService --> IContainerFileTransferService : uses
FileSyncService --> IIgnorePatternMatcher : filters
CommandRunner --> IContainerService : executes
LogRunner --> IContainerService : streams

' File System Watcher
FileSyncService o--> FileSystemWatcher : monitors

' ====================================================================
' EXTERNAL COMPONENTS
' ====================================================================
class FileSystemWatcher <<.NET>> #LightGray {
    + Changed: event
    + Created: event
    + Deleted: event
    + Renamed: event
}

' ====================================================================
' DATA FLOW
' ====================================================================
note as N1
    <b>File Sync Flow:</b>
    FileSystemWatcher detects change
        → FileSyncService.OnFileChanged()
        → IgnorePatternMatcher.IsIgnored()
        → ContainerFileTransferService.CopyToContainerAsync()
        → IContainerService.CopyFileToContainerAsync()
        → Docker.DotNet API
end note

note as N2
    <b>Interactive Command Flow:</b>
    User Input
        → CommandRunner.TryWriteLineToInteractiveAsync()
        → Channel<string>.Writer
        → IContainerService.StreamExecAsync()
        → Container stdin/stdout
        → ChannelReader<(bool, string)>
        → UI Display
end note

N1 .. FileSyncService
N2 .. CommandRunner

@enduml
